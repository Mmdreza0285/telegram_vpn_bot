from aiogram import Router, F
from aiogram.types import Message, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from database.db import save_user_config

router = Router()

class ConfigSubmitState(StatesGroup):
    waiting_for_config = State()
    waiting_for_protocol = State()
    waiting_for_country = State()

@router.message(F.text == "â• Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ÙÛŒÚ¯")
async def start_submit(message: Message, state: FSMContext):
    await message.answer("ğŸ“ Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ù†ÙÛŒÚ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ (Ù…ØªÙ† ÛŒØ§ ÙØ§ÛŒÙ„):")
    await state.set_state(ConfigSubmitState.waiting_for_config)

@router.message(ConfigSubmitState.waiting_for_config)
async def get_config(message: Message, state: FSMContext):
    config_data = message.text if message.text else None
    if not config_data:
        await message.answer("âŒ ÙÙ‚Ø· Ù…ØªÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹.")
        return
    await state.update_data(config=config_data)
    # Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆØªÚ©Ù„
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="Vmess", callback_data="proto_vm"), InlineKeyboardButton(text="Vless", callback_data="proto_vl")],
        [InlineKeyboardButton(text="SS", callback_data="proto_ss"), InlineKeyboardButton(text="Hysteria", callback_data="proto_hy")]
    ])
    await message.answer("ğŸ” Ù¾Ø±ÙˆØªÚ©Ù„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    await state.set_state(ConfigSubmitState.waiting_for_protocol)

@router.callback_query(F.data.startswith("proto_"))
async def protocol_selected(callback, state: FSMContext):
    protocol = callback.data.split("_")[1]
    await state.update_data(protocol=protocol)
    await callback.message.edit_text("ğŸŒ Ú©Ø´ÙˆØ± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ø§Ù†ÙÛŒÚ¯ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:")
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù†", callback_data="ctry_de"), InlineKeyboardButton(text="ğŸ‡ºğŸ‡¸ Ø¢Ù…Ø±ÛŒÚ©Ø§", callback_data="ctry_us")],
        [InlineKeyboardButton(text="ğŸ‡«ğŸ‡· ÙØ±Ø§Ù†Ø³Ù‡", callback_data="ctry_fr"), InlineKeyboardButton(text="ğŸ‡·ğŸ‡º Ø±ÙˆØ³ÛŒÙ‡", callback_data="ctry_ru")]
    ])
    await callback.message.answer("ğŸ‘‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    await state.set_state(ConfigSubmitState.waiting_for_country)

@router.callback_query(F.data.startswith("ctry_"))
async def country_selected(callback, state: FSMContext):
    country = callback.data.split("_")[1]
    data = await state.get_data()
    save_user_config(
        user_id=callback.from_user.id,
        config=data["config"],
        protocol=data["protocol"],
        country=country
    )
    await callback.message.edit_text("âœ… Ú©Ø§Ù†ÙÛŒÚ¯ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯. Ù…ØªØ´Ú©Ø±ÛŒÙ…!")
    await state.clear()
